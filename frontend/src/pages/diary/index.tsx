import { fabric } from 'fabric';
import { useEffect, useState, useRef } from 'react';
import axios from 'axios';
import styled from 'styled-components';

const Container = styled.div`
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #F9F3EE;
`;

const Diary = () => {
    const canvasRef = useRef(null);
    
    const [ canvas, setCanvas ] = useState(null);
    const [ content, setContent ] = useState(null);
    
    const resizeCanvas = () => {
        if(canvas) {
            const outerCanvasContainer = document.querySelector('#canvas');
            if (outerCanvasContainer) {
                const ratio = canvas.width / canvas.height;
                const containerWidth = outerCanvasContainer.clientWidth;
                const scale = containerWidth / canvas.width;
                const zoom = canvas.getZoom() * scale;
                canvas.setDimensions({width: containerWidth, height: containerWidth / ratio});
                canvas.setViewportTransform([zoom, 0, 0, zoom, 0, 0]);
            }
        }
    }

    useEffect(() => {
        
        // 캔버스 생성
        const newCanvas = new fabric.Canvas(canvasRef.current, {
            width: 950,
            height: 1100,
            backgroundColor: '#FFFEFC'
        });

        fabric.Object.prototype.set({
            cornerSize: 7,
            cornerStyle: 'rect',
            transparentCorners: false,
            cornerColor: '#CDCDCD',
            borderColor: '#CDCDCD',
        });
        
        // const diaryId = '65f93ffbc7d180465e2f3e9d';
        
        // const getDiary = (diaryId: string) => {
        //     axios({
        //         url: `http://localhost:8080/diary/${diaryId}`,
        //         method: 'GET'
        //     })
        //     .then((resp) => {
        //         newCanvas.loadFromJSON(resp.data.dailyContent, newCanvas.renderAll.bind(newCanvas));
        //     });
        // }
        
        // getDiary(diaryId);
        
        const dailyContent = {"version":"5.3.0","objects":[{"type":"textbox","version":"5.3.0","originX":"left","originY":"top","left":50,"top":50,"width":100,"height":27.12,"fill":"#FFC814","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeDashOffset":0,"strokeLineJoin":"miter","strokeUniform":false,"strokeMiterLimit":4,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"backgroundColor":"","fillRule":"nonzero","paintFirst":"fill","globalCompositeOperation":"source-over","skewX":0,"skewY":0,"fontFamily":"Cafe24Supermagic","fontWeight":"bold","fontSize":24,"text":"민지:)","underline":false,"overline":false,"linethrough":false,"textAlign":"center","fontStyle":"normal","lineHeight":1.16,"textBackgroundColor":"","charSpacing":0,"styles":[],"direction":"ltr","path":null,"pathStartOffset":0,"pathSide":"left","pathAlign":"baseline","minWidth":20,"splitByGrapheme":false},{"type":"image","version":"5.3.0","originX":"left","originY":"top","left":300,"top":300,"width":310,"height":285,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":0,"strokeDashArray":null,"strokeLineCap":"butt","strokeDashOffset":0,"strokeLineJoin":"miter","strokeUniform":false,"strokeMiterLimit":4,"scaleX":0.48,"scaleY":0.48,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"backgroundColor":"","fillRule":"nonzero","paintFirst":"fill","globalCompositeOperation":"source-over","skewX":0,"skewY":0,"cropX":0,"cropY":0,"src":"http://localhost:3000/static/media/joyIcon.fb833b1cfe308ece5a29.png","crossOrigin":null,"filters":[]},{"type":"path","version":"5.3.0","originX":"left","originY":"top","left":114.97,"top":155.95,"width":63.85,"height":40.92,"fill":null,"stroke":"#FFC814","strokeWidth":5,"strokeDashArray":null,"strokeLineCap":"round","strokeDashOffset":0,"strokeLineJoin":"round","strokeUniform":false,"strokeMiterLimit":10,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"backgroundColor":"","fillRule":"nonzero","paintFirst":"fill","globalCompositeOperation":"source-over","skewX":0,"skewY":0,"path":[["M",154.3917112707808,161.4510921077315],["Q",154.3867112707808,161.44609210773152,153.38908159154326,161.44609210773152],["Q",152.3914519123057,161.44609210773152,151.3938070100989,160.44798621199197],["Q",150.3961621078921,159.44988031625246,149.89730540510786,159.44988031625246],["Q",149.3984487023236,159.44988031625246,148.8996300569625,159.44988031625246],["Q",148.40081141160144,159.44988031625246,147.902000377725,159.44988031625246],["Q",147.40318934384854,159.44988031625246,146.40554444164172,159.44988031625246],["Q",145.4078995394349,159.44988031625246,144.4102241912896,158.95080452320315],["Q",143.41254884314426,158.4517287301538,142.9137378092678,158.4517287301538],["Q",142.41492677539134,158.4517287301538,141.91610051854562,158.4517287301538],["Q",141.4172742616999,158.4517287301538,140.9184556163388,158.4517287301538],["Q",140.41963697097773,158.4517287301538,139.42196162283238,158.4517287301538],["Q",138.42428627468706,158.4517287301538,137.9254752408106,158.4517287301538],["Q",137.42666420693416,158.4517287301538,136.92783795008842,158.4517287301538],["Q",136.4290116932427,158.4517287301538,135.93019304788163,158.4517287301538],["Q",135.43137440252053,158.4517287301538,134.9325176997363,158.4517287301538],["Q",134.43366099695206,158.4517287301538,133.93484235159096,158.4517287301538],["Q",133.43602370622986,158.4517287301538,132.9372050608688,158.4517287301538],["Q",132.4383864155077,158.4517287301538,131.9395677701466,158.95080452320315],["Q",131.44074912478553,159.44988031625246,130.44307377664018,159.94892564906235],["Q",129.44539842849485,160.44797098187226,128.4477611377727,160.9470315448019],["Q",127.4501238470505,161.44609210773152,126.95130520168942,161.94515267066112],["Q",126.45248655632834,162.44421323359074,125.95366791096725,162.44421323359074],["Q",125.45484926560616,162.44421323359074,124.45717391746082,163.4423495895697],["Q",123.45949856931549,164.44048594554866,122.9606799239544,164.93953127835857],["Q",122.46186127859332,165.43857661116846,121.96304263323222,165.43857661116846],["Q",121.46422398787114,165.43857661116846,120.96540534251005,165.93763717409809],["Q",120.46658669714897,166.43669773702769,120.46658669714897,167.4348188628869],["Q",120.46658669714897,168.43293998874617,119.96772999436473,168.93201578179549],["Q",119.46887329158048,169.43109157484483,119.46887329158048,169.93013690765474],["Q",119.46887329158048,170.42918224046463,118.97005464621938,170.92824280339426],["Q",118.4712360008583,171.42730336632386,117.97241735549721,172.42542449218308],["Q",117.47359871013613,173.42354561804234,117.47359871013613,174.4216667439016],["Q",117.47359871013613,175.41978786976082,117.47359871013613,175.91884843269042],["Q",117.47359871013613,176.41790899562005,117.47359871013613,177.41603012147928],["Q",117.47359871013613,178.4141512473385,117.47359871013613,179.41227237319777],["Q",117.47359871013613,180.410393499057,117.47359871013613,180.9094540619866],["Q",117.47359871013613,181.40851462491622,117.47359871013613,182.40663575077548],["Q",117.47359871013613,183.4047568766347,117.47359871013613,183.90383266968405],["Q",117.47359871013613,184.40290846273336,117.47359871013613,184.90195379554325],["Q",117.47359871013613,185.40099912835316,117.97241735549721,185.40099912835316],["Q",118.4712360008583,185.40099912835316,118.4712360008583,185.9000596912828],["Q",118.4712360008583,186.39912025421242,118.4712360008583,186.89818081714202],["Q",118.4712360008583,187.39724138007165,118.97005464621938,187.89630194300128],["Q",119.46887329158048,188.39536250593088,119.96772999436473,188.89443829898022],["Q",120.46658669714897,189.39351409202956,120.96540534251005,189.89255942483948],["Q",121.46422398787114,190.39160475764936,121.96304263323222,190.890665320579],["Q",122.46186127859332,191.3897258835086,123.95835527209974,191.88878644643822],["Q",125.45484926560616,192.38784700936785,125.95366791096725,192.38784700936785],["Q",126.45248655632834,192.38784700936785,126.95130520168942,192.88690757229747],["Q",127.4501238470505,193.3859681352271,127.94894249241159,193.3859681352271],["Q",128.4477611377727,193.3859681352271,128.94657978313376,193.88504392827645],["Q",129.44539842849485,194.38411972132576,129.9442551312791,194.88316505413565],["Q",130.44311183406336,195.38221038694556,131.44074912478553,195.8812709498752],["Q",132.4383864155077,196.38033151280482,132.4383864155077,196.87939207573442],["Q",132.4383864155077,197.37845263866404,132.9372050608688,197.37845263866404],["Q",133.43602370622986,197.37845263866404,134.4336990543752,197.87751320159367],["Q",135.43137440252053,198.37657376452327,136.42901930472735,198.87564955757261],["Q",137.42666420693416,199.37472535062196,137.9254752408106,199.37472535062196],["Q",138.42428627468706,199.37472535062196,138.92310492004816,199.37472535062196],["Q",139.42192356540923,199.37472535062196,139.92078026819348,199.37472535062196],["Q",140.41963697097773,199.37472535062196,140.9184556163388,199.37472535062196],["Q",141.4172742616999,199.37472535062196,141.91610051854562,199.37472535062196],["Q",142.41492677539134,199.37472535062196,143.41255645462888,199.37472535062196],["Q",144.41018613386643,199.37472535062196,145.40786148201175,198.87564955757261],["Q",146.4055368301571,198.37657376452327,146.90436308700282,198.37657376452327],["Q",147.40318934384854,198.37657376452327,148.89967572587034,197.87751320159367],["Q",150.3961621078921,197.37845263866404,151.3938070100989,196.87939207573442],["Q",152.3914519123057,196.38033151280482,153.38908159154326,195.8812709498752],["Q",154.3867112707808,195.38221038694556,155.88321287577185,195.38221038694556],["Q",157.3797144807629,195.38221038694556,157.3797144807629,194.88316505413565],["Q",157.3797144807629,194.38411972132576,157.87852551463936,193.88504392827645],["Q",158.3773365485158,193.3859681352271,158.8761551938769,192.88690757229747],["Q",159.374973839238,192.38784700936785,159.87383054202223,192.38784700936785],["Q",160.37268724480649,192.38784700936785,160.87150589016755,192.38784700936785],["Q",161.37032453552865,192.38784700936785,161.8691507923744,192.38784700936785],["Q",162.36797704922012,192.38784700936785,162.86678808309657,192.38784700936785],["Q",163.36559911697302,192.38784700936785,163.36559911697302,191.88878644643822],["Q",163.36559911697302,191.3897258835086,163.86441776233409,191.3897258835086],["Q",164.36323640769518,191.3897258835086,164.86209311047944,190.890665320579],["Q",165.3609498132637,190.39160475764936,165.85976845862479,190.39160475764936],["Q",166.35858710398585,190.39160475764936,166.85741336083157,189.89255942483948],["Q",167.3562396176773,189.39351409202956,167.85505065155374,189.39351409202956],["Q",168.3538616854302,189.39351409202956,168.8526803307913,189.39351409202956],["Q",169.35149897615239,189.39351409202956,170.34917432429773,189.39351409202956],["Q",171.34684967244306,189.39351409202956,171.84567592928877,188.89443829898022],["Q",172.3445021861345,188.39536250593088,173.34213186537204,188.39536250593088],["Q",174.33976154460956,188.39536250593088,174.8386182473938,187.89630194300128],["Q",175.33747495017806,187.39724138007165,175.83629359553913,187.39724138007165],["Q",176.33511224090023,187.39724138007165,176.83393849774595,186.89818081714202],["Q",177.33276475459166,186.39912025421242,177.83157578846811,186.39912025421242],["Q",178.3303868223446,186.39912025421242,178.82920546770566,185.9000596912828],["Q",179.32802411306676,185.40099912835316,180.32569946121208,184.90195379554325],["L",181.32837480935743,184.39790846273337]]},{"type":"path","version":"5.3.0","originX":"left","originY":"top","left":156.87,"top":121.02,"width":28.93,"height":61.89,"fill":null,"stroke":"#FFC814","strokeWidth":5,"strokeDashArray":null,"strokeLineCap":"round","strokeDashOffset":0,"strokeLineJoin":"round","strokeUniform":false,"strokeMiterLimit":10,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"backgroundColor":"","fillRule":"nonzero","paintFirst":"fill","globalCompositeOperation":"source-over","skewX":0,"skewY":0,"path":[["M",159.374973839238,156.4604864784353],["Q",159.374973839238,156.45548647843532,159.374973839238,155.9564259155057],["Q",159.374973839238,155.4573653525761,159.374973839238,154.95832001976618],["Q",159.374973839238,154.4592746869563,159.374973839238,153.46115356109703],["Q",159.374973839238,152.4630324352378,159.374973839238,151.46489607925884],["Q",159.374973839238,150.4667597232799,159.374973839238,149.96771439047],["Q",159.374973839238,149.4686690576601,159.374973839238,148.47054793180087],["Q",159.374973839238,147.47242680594164,159.374973839238,146.9733510128923],["Q",159.374973839238,146.47427521984295,159.374973839238,145.47616932410344],["Q",159.374973839238,144.47806342836392,159.374973839238,142.98086650945535],["Q",159.374973839238,141.48366959054678,159.374973839238,140.98460902761718],["Q",159.374973839238,140.48554846468755,159.374973839238,139.4874273388283],["Q",159.374973839238,138.48930621296907,159.374973839238,137.99026088015916],["Q",159.374973839238,137.49121554734927,159.374973839238,136.99213975429993],["Q",159.374973839238,136.49306396125058,159.374973839238,135.99400339832096],["Q",159.374973839238,135.49494283539136,159.374973839238,134.99589750258144],["Q",159.374973839238,134.49685216977156,159.374973839238,133.99777637672224],["Q",159.374973839238,133.4987005836729,159.374973839238,132.999655250863],["Q",159.374973839238,132.50060991805307,159.374973839238,132.00153412500373],["Q",159.374973839238,131.50245833195441,160.37264918738333,131.0033977690248],["Q",161.37032453552865,130.5043372060952,161.37032453552865,130.00529187328527],["Q",161.37032453552865,129.5062465404754,162.36796182625085,129.00717074742604],["Q",163.36559911697302,128.5080949543767,163.86441776233409,128.00904962156682],["Q",164.36323640769518,127.5100042887569,164.36323640769518,127.01092849570756],["Q",164.36323640769518,126.51185270265823,165.3609117558405,126.51185270265823],["Q",166.35858710398585,126.51185270265823,166.35858710398585,126.01279213972862],["Q",166.35858710398585,125.51373157679899,166.85741336083157,125.51373157679899],["Q",167.3562396176773,125.51373157679899,167.3562396176773,125.01468624398909],["Q",167.3562396176773,124.51564091117919,167.85505065155374,124.51564091117919],["Q",168.3538616854302,124.51564091117919,168.8526803307913,124.51564091117919],["Q",169.35149897615239,124.51564091117919,169.85035567893664,124.51564091117919],["Q",170.34921238172086,124.51564091117919,170.34921238172086,124.01656511812985],["Q",170.34921238172086,123.51748932508052,170.84803102708196,123.51748932508052],["Q",171.34684967244306,123.51748932508052,171.84567592928877,123.51748932508052],["Q",172.3445021861345,123.51748932508052,172.84331322001094,123.51748932508052],["Q",173.3421242538874,123.51748932508052,173.8409428992485,124.01656511812985],["Q",174.33976154460956,124.51564091117919,174.8386182473938,125.01468624398909],["Q",175.33747495017806,125.51373157679899,175.83629359553913,126.01279213972862],["Q",176.33511224090023,126.51185270265823,176.83393849774595,127.01092849570756],["Q",177.33276475459166,127.5100042887569,177.33276475459166,128.00904962156682],["Q",177.33276475459166,128.5080949543767,177.83157578846811,129.00717074742604],["Q",178.3303868223446,129.5062465404754,178.3303868223446,130.00529187328527],["Q",178.3303868223446,130.5043372060952,178.82920546770566,131.0033977690248],["Q",179.32802411306676,131.50245833195441,179.32802411306676,132.00153412500373],["Q",179.32802411306676,132.50060991805307,179.826880815851,133.4987310439123],["Q",180.32573751863526,134.49685216977156,181.32338242084205,135.49495806551107],["Q",182.32102732304887,136.49306396125058,182.81983835692532,136.99213975429993],["Q",183.31864939080177,137.49121554734927,184.31632473894712,138.4893366732085],["Q",185.31400008709244,139.48745779906773,185.31400008709244,139.98650313187764],["Q",185.31400008709244,140.48554846468755,185.81281873245354,140.98460902761718],["Q",186.3116373778146,141.48366959054678,186.3116373778146,141.98274538359613],["Q",186.3116373778146,142.48182117664544,186.3116373778146,143.4799423025047],["Q",186.3116373778146,144.47806342836392,186.81044841169108,144.47806342836392],["Q",187.30925944556753,144.47806342836392,187.30925944556753,144.97710876117384],["Q",187.30925944556753,145.47615409398372,187.80808570241325,146.47429044996267],["Q",188.30691195925897,147.47242680594164,188.30691195925897,148.47054793180087],["Q",188.30691195925897,149.4686690576601,188.30691195925897,149.96771439047],["Q",188.30691195925897,150.4667597232799,188.30691195925897,150.96582028620952],["Q",188.30691195925897,151.46488084913915,188.30691195925897,152.46300197499838],["Q",188.30691195925897,153.4611231008576,188.30691195925897,154.45924422671686],["Q",188.30691195925897,155.4573653525761,188.30691195925897,156.45548647843532],["Q",188.30691195925897,157.45360760429455,188.30691195925897,157.95266816722418],["Q",188.30691195925897,158.4517287301538,188.30691195925897,159.44984985601303],["Q",188.30691195925897,160.44797098187226,188.30691195925897,160.9470315448019],["Q",188.30691195925897,161.44609210773152,188.30691195925897,161.94515267066112],["Q",188.30691195925897,162.44421323359074,188.30691195925897,163.4423495895697],["Q",188.30691195925897,164.44048594554866,188.30691195925897,165.43859184128817],["Q",188.30691195925897,166.43669773702769,188.30691195925897,166.93575829995729],["Q",188.30691195925897,167.4348188628869,188.30691195925897,167.93387942581654],["Q",188.30691195925897,168.43293998874617,188.30691195925897,168.93201578179549],["Q",188.30691195925897,169.43109157484483,187.80808570241325,169.43109157484483],["Q",187.30925944556753,169.43109157484483,187.30925944556753,169.93013690765474],["Q",187.30925944556753,170.42918224046463,187.30925944556753,170.92824280339426],["Q",187.30925944556753,171.42730336632386,186.81044841169108,172.42542449218308],["Q",186.3116373778146,173.42354561804234,186.3116373778146,173.92262141109165],["Q",186.3116373778146,174.421697204141,186.3116373778146,174.9207425369509],["Q",186.3116373778146,175.41978786976082,186.3116373778146,175.91884843269042],["Q",186.3116373778146,176.41790899562005,186.3116373778146,176.91696955854968],["Q",186.3116373778146,177.41603012147928,185.81281873245354,177.41603012147928],["Q",185.31400008709244,177.41603012147928,185.31400008709244,177.91509068440888],["Q",185.31400008709244,178.4141512473385,185.31400008709244,178.91322704038785],["Q",185.31400008709244,179.4123028334372,185.31400008709244,179.91134816624708],["Q",185.31400008709244,180.410393499057,184.8151433843082,180.9094540619866],["Q",184.31628668152393,181.40851462491622,184.31628668152393,181.90757518784585],["Q",184.31628668152393,182.40663575077548,183.81746803616284,182.40663575077548],["Q",183.31864939080177,182.40663575077548,183.31864939080177,182.9056963137051],["Q",183.31864939080177,183.4047568766347,183.31864939080177,184.40287800249394],["L",183.31864939080177,185.40599912835316]]}],"background":"#FFFEFC"};
        // JSON으로부터 캔버스 로드 후, 모든 객체를 선택 불가능하게 설정
        newCanvas.loadFromJSON(dailyContent, () => {
            newCanvas.renderAll();
            // 모든 객체를 순회하면서 selectable 속성을 false로 설정
            newCanvas.forEachObject((obj) => {
                obj.selectable = false;
            });
        });

        setCanvas(newCanvas);

        window.addEventListener('resize', resizeCanvas);

        // 언마운트 시 캔버스 정리
        return () => {
            newCanvas.dispose();
        };
    }, []);

    return (
        <Container>
            <canvas id="canvas" style={{ border: "1px solid #9E9D9D"  }} ref={ canvasRef }/>
        </Container>
    )
};

export default Diary;